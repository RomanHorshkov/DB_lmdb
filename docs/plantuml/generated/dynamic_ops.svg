<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="956.6667px" preserveAspectRatio="none" style="width:1462px;height:956px;" version="1.1" viewBox="0 0 1462 956" width="1462.7083px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="398.125" x="533.3854" y="33.5345">Operation flow — using a DBI descriptor</text><rect fill="#FFFFFF" height="113.5449" rx="5.8333" ry="5.8333" style="stroke: #000000; stroke-width: 2.9166666666666665;" width="623.4375" x="822.5" y="462.8613"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="35" x2="35" y1="164.1992" y2="728.654"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="359.4792" x2="359.4792" y1="164.1992" y2="728.654"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="721.875" x2="721.875" y1="164.1992" y2="728.654"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="908.5417" x2="908.5417" y1="164.1992" y2="728.654"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="1273.8542" x2="1273.8542" y1="164.1992" y2="728.654"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="1397.8125" x2="1397.8125" y1="164.1992" y2="728.654"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="39.375" x="11.6667" y="159.3842">App</text><ellipse cx="35.7292" cy="63.1413" fill="#FEFECE" rx="11.6667" ry="11.6667" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><path d="M35.7292,74.8079 L35.7292,114.1829 M16.7708,86.4746 L54.6875,86.4746 M35.7292,114.1829 L16.7708,136.0579 M35.7292,114.1829 L54.6875,136.0579 " fill="none" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="39.375" x="11.6667" y="746.1469">App</text><ellipse cx="35.7292" cy="765.5452" fill="#FEFECE" rx="11.6667" ry="11.6667" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><path d="M35.7292,777.2119 L35.7292,816.5869 M16.7708,788.8786 L54.6875,788.8786 M35.7292,816.5869 L16.7708,838.4619 M35.7292,816.5869 L54.6875,838.4619 " fill="none" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="192.5" x="263.2292" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="172.0833" x="273.4375" y="148.0614">ops_* (db_lmdb.h)</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="192.5" x="263.2292" y="727.1956"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="172.0833" x="273.4375" y="755.0015">ops_* (db_lmdb.h)</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="199.7917" x="622.7083" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="179.375" x="632.9167" y="148.0614">db_lmdb_dbi cache</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="199.7917" x="622.7083" y="727.1956"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="179.375" x="632.9167" y="755.0015">db_lmdb_dbi cache</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="144.375" x="837.0833" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="123.9583" x="847.2917" y="148.0614">db_lmdb_ops</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="144.375" x="837.0833" y="727.1956"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="123.9583" x="847.2917" y="755.0015">db_lmdb_ops</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="151.6667" x="1198.0208" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="131.25" x="1208.2292" y="148.0614">db_lmdb_core</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="151.6667" x="1198.0208" y="727.1956"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="131.25" x="1208.2292" y="755.0015">db_lmdb_core</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="58.3333" x="1364.2708" y="159.3842">LMDB</text><path d="M1371.5625,87.9329 C1371.5625,73.3496 1397.8125,73.3496 1397.8125,73.3496 C1397.8125,73.3496 1424.0625,73.3496 1424.0625,87.9329 L1424.0625,125.8496 C1424.0625,140.4329 1397.8125,140.4329 1397.8125,140.4329 C1397.8125,140.4329 1371.5625,140.4329 1371.5625,125.8496 L1371.5625,87.9329 " fill="#FEFECE" style="stroke: #000000; stroke-width: 2.1875;"/><path d="M1371.5625,87.9329 C1371.5625,102.5163 1397.8125,102.5163 1397.8125,102.5163 C1397.8125,102.5163 1424.0625,102.5163 1424.0625,87.9329 " fill="none" style="stroke: #000000; stroke-width: 2.1875;"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="58.3333" x="1364.2708" y="746.1469">LMDB</text><path d="M1371.5625,765.5452 C1371.5625,750.9619 1397.8125,750.9619 1397.8125,750.9619 C1397.8125,750.9619 1424.0625,750.9619 1424.0625,765.5452 L1424.0625,803.4619 C1424.0625,818.0452 1397.8125,818.0452 1397.8125,818.0452 C1397.8125,818.0452 1371.5625,818.0452 1371.5625,803.4619 L1371.5625,765.5452 " fill="#FEFECE" style="stroke: #000000; stroke-width: 2.1875;"/><path d="M1371.5625,765.5452 C1371.5625,780.1286 1397.8125,780.1286 1397.8125,780.1286 C1397.8125,780.1286 1424.0625,780.1286 1424.0625,765.5452 " fill="none" style="stroke: #000000; stroke-width: 2.1875;"/><polygon fill="#2563EB" points="341.9792,203.7679,356.5625,209.6012,341.9792,215.4346,347.8125,209.6012" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="35.7292" x2="350.7292" y1="209.6012" y2="209.6012"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="288.75" x="53.2292" y="202.2134">ops_exec(desc_id, work_items)</text><polygon fill="#2563EB" points="705.1042,246.2533,719.6875,252.0866,705.1042,257.9199,710.9375,252.0866" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="359.4792" x2="713.8542" y1="252.0866" y2="252.0866"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="328.125" x="376.9792" y="244.6988">lookup dbi_desc_t by id (db.h/dbi.h)</text><polygon fill="#2563EB" points="891.7708,288.7386,906.3542,294.5719,891.7708,300.4053,897.6042,294.5719" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="359.4792" x2="900.5208" y1="294.5719" y2="294.5719"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="342.7083" x="463.0208" y="287.1841">ops_exec_internal(desc, work_items)</text><polygon fill="#2563EB" points="1256.3542,331.224,1270.9375,337.0573,1256.3542,342.8906,1262.1875,337.0573" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="909.2708" x2="1265.1042" y1="337.0573" y2="337.0573"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="329.5833" x="926.7708" y="329.6695">db_lmdb_txn_begin_safe(DB-&gt;env)</text><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="909.2708" x2="970.5208" y1="379.5426" y2="379.5426"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="970.5208" x2="970.5208" y1="379.5426" y2="398.501"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="910.7292" x2="970.5208" y1="398.501" y2="398.501"/><polygon fill="#2563EB" points="925.3125,392.6676,910.7292,398.501,925.3125,404.3343,919.4792,398.501" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="323.75" x="919.4792" y="372.1548">batch work in void_store (ops-only)</text><polygon fill="#2563EB" points="1380.3125,435.153,1394.8958,440.9863,1380.3125,446.8197,1386.1458,440.9863" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="909.2708" x2="1389.0625" y1="440.9863" y2="440.9863"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="304.7917" x="1001.1458" y="433.5985">mdb_put / mdb_get / mdb_del ...</text><path d="M828.3333,462.8613 L915.8333,462.8613 L915.8333,474.528 L901.25,489.1113 L822.5,489.1113 L822.5,468.6947 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.4583333333333333;"/><rect fill="none" height="113.5449" rx="5.8333" ry="5.8333" style="stroke: #000000; stroke-width: 2.9166666666666665;" width="623.4375" x="822.5" y="462.8613"/><text fill="#000000" font-family="Arial" font-size="20.4167" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27.7083" x="844.375" y="483.2709">alt</text><text fill="#000000" font-family="Arial" font-size="20.4167" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263.9583" x="937.7083" y="484.7292">[needs resize or retry]</text><polygon fill="#2563EB" points="925.3125,516.4209,910.7292,522.2542,925.3125,528.0876,919.4792,522.2542" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="916.5625" x2="1272.3958" y1="522.2542" y2="522.2542"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="188.125" x="997.5" y="514.8664">retry_with_resize(...)</text><polygon fill="#2563EB" points="1380.3125,558.9063,1394.8958,564.7396,1380.3125,570.5729,1386.1458,564.7396" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="909.2708" x2="1389.0625" y1="564.7396" y2="564.7396"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="185.2083" x="1060.9375" y="557.3518">re-run op in new txn</text><polygon fill="#2563EB" points="1256.3542,611.5999,1270.9375,617.4333,1256.3542,623.2666,1262.1875,617.4333" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="909.2708" x2="1265.1042" y1="617.4333" y2="617.4333"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="294.5833" x="944.2708" y="610.0455">db_lmdb_txn_commit_safe(txn)</text><polygon fill="#2563EB" points="375.5208,654.0853,360.9375,659.9186,375.5208,665.752,369.6875,659.9186" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="366.7708" x2="907.8125" y1="659.9186" y2="659.9186"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="154.5833" x="557.0833" y="652.5308">result/error code</text><polygon fill="#2563EB" points="51.7708,696.5706,37.1875,702.404,51.7708,708.2373,45.9375,702.404" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="43.0208" x2="358.0208" y1="702.404" y2="702.404"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="158.9583" x="118.125" y="695.0162">status + payload</text><rect fill="#DDDDDD" height="85.8822" rx="7.2917" ry="7.2917" style="stroke: #000000; stroke-width: 1.4583333333333333;" width="634.375" x="813.0208" y="855.9619"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="520.625" x="821.7708" y="882.2048">- dbi_desc_t bridges public callers and DBI internals.</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="508.9583" x="821.7708" y="905.9711">- void_store is ops-only; never leak buffers upward.</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="616.875" x="821.7708" y="929.7373">- Retry/resize stays inside db_lmdb_core for uniform behavior.</text><!--MD5=[3b4842f1fdff297731399b5a99ada31e]
@startuml
skinparam shadowing false
skinparam roundCorner 8
skinparam backgroundColor #FFFFFF
skinparam dpi 140
skinparam defaultFontName "Arial"
skinparam defaultFontSize 14
skinparam defaultTextAlignment left
skinparam ArrowColor #2563EB
skinparam ArrowThickness 1.5
skinparam ArrowFontSize 13
skinparam sequence {
  ArrowColor #2563EB
  LifeLineBorderColor #94A3B8
  LifeLineBackgroundColor #F8FAFC
  ParticipantBorderColor #1F2937
  ParticipantBackgroundColor #E5E7EB
  ParticipantFontColor #0F172A
  ParticipantFontSize 13
  MessageAlign center
  BoxBorderColor #CBD5E1
  BoxBackgroundColor #F8FAFC
}

title Operation flow — using a DBI descriptor

actor App as Caller
participant API as "ops_* (db_lmdb.h)"
participant DBI as "db_lmdb_dbi cache"
participant Ops as "db_lmdb_ops"
participant Core as "db_lmdb_core"
database LMDB as "LMDB"

Caller -> API : ops_exec(desc_id, work_items)
API -> DBI : lookup dbi_desc_t by id (db.h/dbi.h)
API -> Ops : ops_exec_internal(desc, work_items)
Ops -> Core : db_lmdb_txn_begin_safe(DB->env)
Ops -> Ops : batch work in void_store (ops-only)
Ops -> LMDB : mdb_put / mdb_get / mdb_del ...
alt needs resize or retry
    Core - -> Ops : retry_with_resize(...)
    Ops -> LMDB : re-run op in new txn
end
Ops -> Core : db_lmdb_txn_commit_safe(txn)
Ops - -> API : result/error code
API - -> Caller : status + payload

legend right
- dbi_desc_t bridges public callers and DBI internals.
- void_store is ops-only; never leak buffers upward.
- Retry/resize stays inside db_lmdb_core for uniform behavior.
endlegend

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 21.0.8+9-Ubuntu-0ubuntu124.04.1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>