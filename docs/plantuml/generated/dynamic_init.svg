<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="998.9583px" preserveAspectRatio="none" style="width:1821px;height:998px;" version="1.1" viewBox="0 0 1821 998" width="1821.4583px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="271.25" x="776.1979" y="33.5345">Init flow — env + DBI setup</text><rect fill="#FFFFFF" height="174.9886" rx="5.8333" ry="5.8333" style="stroke: #000000; stroke-width: 2.9166666666666665;" width="842.9167" x="942.8125" y="443.903"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="35" x2="35" y1="164.1992" y2="771.1393"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="455" x2="455" y1="164.1992" y2="771.1393"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="1033.2292" x2="1033.2292" y1="164.1992" y2="771.1393"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="1456.875" x2="1456.875" y1="164.1992" y2="771.1393"/><line style="stroke: #94A3B8; stroke-width: 1.4583333333333333; stroke-dasharray: 5.0,5.0;" x1="1778.4375" x2="1778.4375" y1="164.1992" y2="771.1393"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="39.375" x="11.6667" y="159.3842">App</text><ellipse cx="35.7292" cy="63.1413" fill="#FEFECE" rx="11.6667" ry="11.6667" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><path d="M35.7292,74.8079 L35.7292,114.1829 M16.7708,86.4746 L54.6875,86.4746 M35.7292,114.1829 L16.7708,136.0579 M35.7292,114.1829 L54.6875,136.0579 " fill="none" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="39.375" x="11.6667" y="788.6322">App</text><ellipse cx="35.7292" cy="808.0306" fill="#FEFECE" rx="11.6667" ry="11.6667" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><path d="M35.7292,819.6973 L35.7292,859.0723 M16.7708,831.3639 L54.6875,831.3639 M35.7292,859.0723 L16.7708,880.9473 M35.7292,859.0723 L54.6875,880.9473 " fill="none" style="stroke: #A80036; stroke-width: 2.9166666666666665;"/><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="138.5417" x="386.4583" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="118.125" x="396.6667" y="148.0614">db_lmdb_init</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="138.5417" x="386.4583" y="769.681"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="118.125" x="396.6667" y="797.4869">db_lmdb_init</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="151.6667" x="957.3958" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="131.25" x="967.6042" y="148.0614">db_lmdb_core</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="151.6667" x="957.3958" y="769.681"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="131.25" x="967.6042" y="797.4869">db_lmdb_core</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="176.4583" x="1369.375" y="120.2555"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="156.0417" x="1379.5833" y="148.0614">db_lmdb_dbi_init</text><rect fill="#E5E7EB" height="42.4854" rx="5.8333" ry="5.8333" style="stroke: #1F2937; stroke-width: 2.1875;" width="176.4583" x="1369.375" y="769.681"/><text fill="#0F172A" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="156.0417" x="1379.5833" y="797.4869">db_lmdb_dbi_init</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="58.3333" x="1744.8958" y="159.3842">LMDB</text><path d="M1752.1875,87.9329 C1752.1875,73.3496 1778.4375,73.3496 1778.4375,73.3496 C1778.4375,73.3496 1804.6875,73.3496 1804.6875,87.9329 L1804.6875,125.8496 C1804.6875,140.4329 1778.4375,140.4329 1778.4375,140.4329 C1778.4375,140.4329 1752.1875,140.4329 1752.1875,125.8496 L1752.1875,87.9329 " fill="#FEFECE" style="stroke: #000000; stroke-width: 2.1875;"/><path d="M1752.1875,87.9329 C1752.1875,102.5163 1778.4375,102.5163 1778.4375,102.5163 C1778.4375,102.5163 1804.6875,102.5163 1804.6875,87.9329 " fill="none" style="stroke: #000000; stroke-width: 2.1875;"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="58.3333" x="1744.8958" y="788.6322">LMDB</text><path d="M1752.1875,808.0306 C1752.1875,793.4473 1778.4375,793.4473 1778.4375,793.4473 C1778.4375,793.4473 1804.6875,793.4473 1804.6875,808.0306 L1804.6875,845.9473 C1804.6875,860.5306 1778.4375,860.5306 1778.4375,860.5306 C1778.4375,860.5306 1752.1875,860.5306 1752.1875,845.9473 L1752.1875,808.0306 " fill="#FEFECE" style="stroke: #000000; stroke-width: 2.1875;"/><path d="M1752.1875,808.0306 C1752.1875,822.6139 1778.4375,822.6139 1778.4375,822.6139 C1778.4375,822.6139 1804.6875,822.6139 1804.6875,808.0306 " fill="none" style="stroke: #000000; stroke-width: 2.1875;"/><polygon fill="#2563EB" points="438.2292,203.7679,452.8125,209.6012,438.2292,215.4346,444.0625,209.6012" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="35.7292" x2="446.9792" y1="209.6012" y2="209.6012"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="385" x="53.2292" y="202.2134">db_lmdb_init(dbi_decls, n_dbis, meta_dir)</text><polygon fill="#2563EB" points="1015.7292,246.2533,1030.3125,252.0866,1015.7292,257.9199,1021.5625,252.0866" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="455.7292" x2="1024.4792" y1="252.0866" y2="252.0866"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="542.5" x="473.2292" y="244.6988">db_lmdb_create_env_safe(meta_dir, max_dbis, map_size)</text><polygon fill="#2563EB" points="1760.9375,288.7386,1775.5208,294.5719,1760.9375,300.4053,1766.7708,294.5719" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="1033.2292" x2="1769.6875" y1="294.5719" y2="294.5719"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="530.8333" x="1140.4167" y="287.1841">mdb_env_create / set_maxdbs / set_mapsize / env_open</text><polygon fill="#2563EB" points="471.7708,331.224,457.1875,337.0573,471.7708,342.8906,465.9375,337.0573" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="463.0208" x2="1031.7708" y1="337.0573" y2="337.0573"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="142.9167" x="673.0208" y="329.6695">DB-&gt;env ready</text><polygon fill="#2563EB" points="1440.1042,373.7093,1454.6875,379.5426,1440.1042,385.376,1445.9375,379.5426" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="455.7292" x2="1448.8542" y1="379.5426" y2="379.5426"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="290.2083" x="811.5625" y="372.1548">db_lmdb_dbi_init(decls, n_dbis)</text><polygon fill="#2563EB" points="1049.2708,416.1947,1034.6875,422.028,1049.2708,427.8613,1043.4375,422.028" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="1040.5208" x2="1456.1458" y1="422.028" y2="422.028"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="329.5833" x="1080.625" y="414.6402">db_lmdb_txn_begin_safe(DB-&gt;env)</text><path d="M948.6458,443.903 L1058.0208,443.903 L1058.0208,455.5697 L1043.4375,470.153 L942.8125,470.153 L942.8125,449.7363 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.4583333333333333;"/><rect fill="none" height="174.9886" rx="5.8333" ry="5.8333" style="stroke: #000000; stroke-width: 2.9166666666666665;" width="842.9167" x="942.8125" y="443.903"/><text fill="#000000" font-family="Arial" font-size="20.4167" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49.5833" x="964.6875" y="464.3125">loop</text><text fill="#000000" font-family="Arial" font-size="20.4167" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220.2083" x="1079.8958" y="465.7709">[for each dbi_init_t]</text><polygon fill="#2563EB" points="1049.2708,497.4626,1034.6875,503.2959,1049.2708,509.1292,1043.4375,503.2959" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="1040.5208" x2="1456.1458" y1="503.2959" y2="503.2959"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="389.375" x="1050.7292" y="495.9081">db_lmdb_dbi_open_safe(txn, name, flags)</text><polygon fill="#2563EB" points="1049.2708,539.9479,1034.6875,545.7813,1049.2708,551.6146,1043.4375,545.7813" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="1040.5208" x2="1456.1458" y1="545.7813" y2="545.7813"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="345.625" x="1072.6042" y="538.3935">db_lmdb_dbi_get_flags_safe(txn, dbi)</text><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="1457.6042" x2="1518.8542" y1="588.2666" y2="588.2666"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="1518.8542" x2="1518.8542" y1="588.2666" y2="607.2249"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="1459.0625" x2="1518.8542" y1="607.2249" y2="607.2249"/><polygon fill="#2563EB" points="1473.6458,601.3916,1459.0625,607.2249,1473.6458,613.0583,1467.8125,607.2249" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="300.4167" x="1467.8125" y="580.8788">cache dbi_desc_t (flags, names)</text><polygon fill="#2563EB" points="1049.2708,654.0853,1034.6875,659.9186,1049.2708,665.752,1043.4375,659.9186" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875;" x1="1040.5208" x2="1456.1458" y1="659.9186" y2="659.9186"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="294.5833" x="1098.125" y="652.5308">db_lmdb_txn_commit_safe(txn)</text><polygon fill="#2563EB" points="471.7708,696.5706,457.1875,702.404,471.7708,708.2373,465.9375,702.404" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="463.0208" x2="1456.1458" y1="702.404" y2="702.404"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="293.125" x="810.1042" y="695.0162">descriptors stored on DB-&gt;dbis</text><polygon fill="#2563EB" points="51.7708,739.056,37.1875,744.8893,51.7708,750.7227,45.9375,744.8893" style="stroke: #2563EB; stroke-width: 1.4583333333333333;"/><line style="stroke: #2563EB; stroke-width: 2.1875; stroke-dasharray: 2.0,2.0;" x1="43.0208" x2="454.2708" y1="744.8893" y2="744.8893"/><text fill="#000000" font-family="Arial" font-size="18.9583" lengthAdjust="spacingAndGlyphs" textLength="188.125" x="151.6667" y="737.5015">ready for operations</text><rect fill="#DDDDDD" height="85.8822" rx="7.2917" ry="7.2917" style="stroke: #000000; stroke-width: 1.4583333333333333;" width="590.625" x="1215.5208" y="898.4473"/><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="342.7083" x="1224.2708" y="924.6901">- DB owns env + dbi_desc_t array.</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="527.9167" x="1224.2708" y="948.4564">- All LMDB calls only via db_lmdb_core safe wrappers.</text><text fill="#000000" font-family="Arial" font-size="20.4167" lengthAdjust="spacingAndGlyphs" textLength="573.125" x="1224.2708" y="972.2227">- Logging routes through internal.h → EMlog (not shown).</text><!--MD5=[cadfb5a17006902a449dfe02afc05d16]
@startuml
skinparam shadowing false
skinparam roundCorner 8
skinparam backgroundColor #FFFFFF
skinparam dpi 140
skinparam defaultFontName "Arial"
skinparam defaultFontSize 14
skinparam defaultTextAlignment left
skinparam ArrowColor #2563EB
skinparam ArrowThickness 1.5
skinparam ArrowFontSize 13
skinparam sequence {
  ArrowColor #2563EB
  LifeLineBorderColor #94A3B8
  LifeLineBackgroundColor #F8FAFC
  ParticipantBorderColor #1F2937
  ParticipantBackgroundColor #E5E7EB
  ParticipantFontColor #0F172A
  ParticipantFontSize 13
  MessageAlign center
  BoxBorderColor #CBD5E1
  BoxBackgroundColor #F8FAFC
}

title Init flow — env + DBI setup

actor App as Caller
participant API as "db_lmdb_init"
participant Core as "db_lmdb_core"
participant DBI as "db_lmdb_dbi_init"
database LMDB as "LMDB"

Caller -> API : db_lmdb_init(dbi_decls, n_dbis, meta_dir)
API -> Core : db_lmdb_create_env_safe(meta_dir, max_dbis, map_size)
Core -> LMDB : mdb_env_create / set_maxdbs / set_mapsize / env_open
Core - -> API : DB->env ready

API -> DBI : db_lmdb_dbi_init(decls, n_dbis)
DBI -> Core : db_lmdb_txn_begin_safe(DB->env)
loop for each dbi_init_t
    DBI -> Core : db_lmdb_dbi_open_safe(txn, name, flags)
    DBI -> Core : db_lmdb_dbi_get_flags_safe(txn, dbi)
    DBI - -> DBI : cache dbi_desc_t (flags, names)
end
DBI -> Core : db_lmdb_txn_commit_safe(txn)
DBI - -> API : descriptors stored on DB->dbis
API - -> Caller : ready for operations

legend right
- DB owns env + dbi_desc_t array.
- All LMDB calls only via db_lmdb_core safe wrappers.
- Logging routes through internal.h → EMlog (not shown).
endlegend

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 21.0.8+9-Ubuntu-0ubuntu124.04.1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>