@startuml
' Standalone PlantUML for operation flow (no external includes).
skinparam shadowing false
skinparam roundCorner 8
skinparam backgroundColor #FFFFFF
skinparam dpi 140
skinparam defaultFontName "Arial"
skinparam defaultFontSize 14
skinparam defaultTextAlignment left
skinparam ArrowColor #2563EB
skinparam ArrowThickness 1.5
skinparam ArrowFontSize 13
skinparam sequence {
  ArrowColor #2563EB
  LifeLineBorderColor #94A3B8
  LifeLineBackgroundColor #F8FAFC
  ParticipantBorderColor #1F2937
  ParticipantBackgroundColor #E5E7EB
  ParticipantFontColor #0F172A
  ParticipantFontSize 13
  MessageAlign center
  BoxBorderColor #CBD5E1
  BoxBackgroundColor #F8FAFC
}

title Operation flow â€” using a DBI descriptor

actor App as Caller
participant API as "ops_* (db_lmdb.h)"
participant DBI as "db_lmdb_dbi cache"
participant Ops as "db_lmdb_ops"
participant Core as "db_lmdb_core"
database LMDB as "LMDB"

Caller -> API : ops_exec(desc_id, work_items)
API -> DBI : lookup dbi_desc_t by id (db.h/dbi.h)
API -> Ops : ops_exec_internal(desc, work_items)
Ops -> Core : db_lmdb_txn_begin_safe(DB->env)
Ops -> Ops : batch work in void_store (ops-only)
Ops -> LMDB : mdb_put / mdb_get / mdb_del ...
alt needs resize or retry
    Core --> Ops : retry_with_resize(...)
    Ops -> LMDB : re-run op in new txn
end
Ops -> Core : db_lmdb_txn_commit_safe(txn)
Ops --> API : result/error code
API --> Caller : status + payload

legend right
- dbi_desc_t bridges public callers and DBI internals.
- void_store is ops-only; never leak buffers upward.
- Retry/resize stays inside db_lmdb_core for uniform behavior.
endlegend

@enduml
